<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Cytoscape Message Animation</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <style>
    #cy {
      width: 600px;
      height: 400px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body style="display: flex; flex-direction: row; gap: 20px; font-family: sans-serif;">
    <div>

<div id="cy" class="mb-4"></div>

<div class="mb-4">
    <h2>Settings</h2>
    <div class="mb-3">
        <label for="actors_num" class="form-label">Numbers of actors</label>
        <input type="number" class="form-control" id="actors_num" />
    </div>

    <div style="display: flex; flex-direction: row; gap: 10px; align-items: center; justify-content: center;">
        <p>Send</p>
        <select class="form-select" id="messageType">
            <option value="IDENTIFY">IDENTIFY</option>
            <option value="REPLY">REPLY</option>
        </select>
        <p>from</p>
            <select class="form-select" id="fromNode">
                <option value="A">A</option>
                <option value="B">B</option>
            </select>
        <p>to</p>
            <select class="form-select" id="toNode">
                <option value="A">A</option>
                <option value="B">B</option>
            </select>
    </div>
</div>

<button type="button" class="btn btn-primary mb-4" onclick="start()">Start</button>

<div>
    <h2>Log</h2>
    <code id="log"/>
</div>
    </div>


  <textarea rows="40" cols="80" style="margin-left: 20px;">
type Message = // Different types of messages are defined below
| { type: "REQUEST"; }
| { type: "REPLY"; name: string };

// A class with the logic of all actors
class Actor {
    // Define fields of the actor below
    id: number;
    name: string;

    // Receive a message
    receive(from: number, msg: Message) {
        // You must handle each type of message being received

        if (msg.type === "REQUEST") {
            // send a REPLY back
            send(from, { type: "REPLY", name: this.name });
        }

        if (msg.type === "REPLY") {
            print(`Actor ${from}'s name is ${msg.name}`);
        }
    }
}
  </textarea>

  <script>
    const cy = cytoscape({
      container: document.getElementById('cy'),

      elements: [
        { data: { id: 'A', label: 'A' }, position: { x: 150, y: 200 } },
        { data: { id: 'B', label: 'B' }, position: { x: 450, y: 200 } },
        { data: { id: 'AB', source: 'A', target: 'B' } }
      ],

      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'background-color': '#4a90e2',
            'color': '#fff',
            'width': 50,
            'height': 50
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 3,
            'line-color': '#999',
            'target-arrow-shape': 'triangle',
            'target-arrow-color': '#999'
          }
        },
        {
          selector: '.message',
          style: {
            'label': 'data(label)',
            'background-color': '#f5a623',
            'width': 40,
            'height': 40,
            'font-size': 10,
            'text-valign': 'center',
            'text-halign': 'center'
          }
        }
      ]
    });

    function sendMessage(from, to, text) {
      const source = cy.getElementById(from).position();
      const target = cy.getElementById(to).position();
      const log = document.getElementById('log');
      log.innerText += `${from} sent ${text} to ${to}\n`;

      // Create message node at A
      const msg = cy.add({
        group: 'nodes',
        data: { label: text },
        position: { x: source.x, y: source.y },
        classes: 'message'
      });

      // Animate to B
      msg.animate({
        position: { x: target.x, y: target.y }
      }, {
        duration: 2000,
        complete: () => {
          // Remove message when it arrives
          cy.remove(msg);
            log.innerText += `${to} received ${text} from ${from}\n`;
        }
      });
    }

    function start() {
      // Send message after 1 second
      setTimeout(() => sendMessage('A', 'B', 'IDENTIFY'), 200);


      // send reply after another second
      setTimeout(() => sendMessage('B', 'A', 'REPLY'), 3500);
    }
  </script>
</body>
</html>
